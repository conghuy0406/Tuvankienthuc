@model List<Tuvankienthuc.Services.TimelineVm>

@{
    ViewData["Title"] = "Kết quả tư vấn học tập";

    string monHoc = ViewBag.MonHoc ?? "";
    string goal = ViewBag.Goal ?? "";
    int daysLeft = ViewBag.DaysLeft ?? 7;

    string studyPlan = ViewBag.StudyPlan ?? "";

    var goiYBoSung =
        ViewBag.GoiYBoSung as Dictionary<int, string>
        ?? new Dictionary<int, string>();

}

<div class="container my-4">

    <h2 class="fw-bold text-primary mb-2">
        📘 Tư vấn học tập – @monHoc
    </h2>

    <p class="text-muted mb-4">
        🎯 Mục tiêu: <strong>@goal</strong> |
        ⏱ Còn <strong>@daysLeft ngày</strong>
    </p>

    <!-- STUDY PLAN -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white fw-bold">
            📝 Chiến lược ôn tập
        </div>
        <div class="card-body">
            @Html.Raw(studyPlan.Replace("\n", "<br/>"))
        </div>
    </div>

    <!-- TIMELINE -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white fw-bold">
            📅 Timeline học tập
        </div>
        <div class="card-body">

            @foreach (var day in Model)
            {
                <h5 class="fw-bold text-primary mt-3">
                    Ngày @day.Day
                </h5>

                @foreach (var it in day.Items)
                {
                    <div class="card mb-3 shadow-sm">
                        <div class="card-body">

                            <div class="d-flex justify-content-between align-items-center">
                                <strong>📘 @it.NoiDung</strong>
                                <span class="badge bg-info text-dark">
                                    ⏱ @it.Minutes phút
                                </span>
                            </div>

                            <div class="text-muted small mb-2">
                                Chủ đề: @it.ChuDe
                            </div>

                            <!-- TÀI LIỆU -->
                            @if (it.TaiLieu.Any())
                            {
                                <div class="mb-2">
                                    @foreach (var tl in it.TaiLieu)
                                    {
                                        <a href="@tl.DuongDan"
                                           target="_blank"
                                           class="badge bg-light text-dark border me-2 mb-1">
                                            @if (tl.LoaiTL == "PDF")
                                            {
                                                <i class="bi bi-file-earmark-pdf text-danger"></i>
                                            }
                                            else if (tl.LoaiTL == "Video")
                                            {
                                                <i class="bi bi-play-circle text-success"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-link-45deg"></i>
                                            }
                                            @tl.TieuDe
                                        </a>
                                    }
                                </div>
                            }

                            <!-- GỢI Ý AI -->
                            @if (goiYBoSung.ContainsKey(it.MaKT))
                            {
                                <div class="alert alert-info mb-0 mt-2">
                                    🧠 <strong>Gợi ý ôn tập:</strong><br />
                                    @Html.Raw(goiYBoSung[it.MaKT].Replace("\n", "<br/>"))
                                </div>
                            }

                        </div>
                    </div>
                }
            }

        </div>
    </div>
    <div class="card mt-4 shadow-sm">
        <div class="card-header bg-warning fw-bold">
            ⭐ Đánh giá đề xuất
        </div>

        <div class="card-body">
            <form asp-controller="DeXuatDanhGia"
                  asp-action="Create"
                  method="post">

                <!-- MaDX BẮT BUỘC -->
                <input type="hidden" name="maDX" value="@ViewBag.MaDX" />

                <div class="mb-2">
                    <label class="form-label">Mức độ phù hợp</label>
                    <select name="rating" class="form-select" required>
                        <option value="5">⭐⭐⭐⭐⭐ Rất hợp lý</option>
                        <option value="4">⭐⭐⭐⭐ Hợp lý</option>
                        <option value="3">⭐⭐⭐ Bình thường</option>
                        <option value="2">⭐⭐ Chưa hợp lý</option>
                        <option value="1">⭐ Không phù hợp</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Nhận xét (tuỳ chọn)</label>
                    <textarea name="nhanXet"
                              class="form-control"
                              rows="3"
                              placeholder="VD: Timeline hợp lý nhưng thiếu phần Index..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                    Gửi đánh giá
                </button>
            </form>
        </div>
    </div>


</div>
